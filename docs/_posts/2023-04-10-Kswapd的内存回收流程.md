---
layout: post
title: kswapd的简介
date: 2023-4-15 23:18 +0800
last_modified_at: 2023-4-15 22:08:25 +0800
tags: [Linux内核, 内存回收, 笔记]
toc:  true
---

## kswapd的简介

kswapd是内核中负责回收的内核线程，在系统内存不足的时候会被唤醒执行内存回收.

### kswapd的初始化

```c
/*
*  kswapd的初始化
*/
static int __init kswapd_init(void)
{
	int nid;

	swap_setup(); //set the page_cluster
	for_each_node_state(nid, N_MEMORY)
 		kswapd_run(nid);
	return 0;
}
module_init(kswapd_init)
void kswapd_run(int nid)
{
	pg_data_t *pgdat = NODE_DATA(nid);
	pgdat_kswapd_lock(pgdat);
	if (!pgdat->kswapd) {
		pgdat->kswapd = kthread_run(kswapd, pgdat, "kswapd%d", nid);
		if (IS_ERR(pgdat->kswapd)) {
			/* failure at boot is fatal */
			BUG_ON(system_state < SYSTEM_RUNNING);
			pr_err("Failed to start kswapd on node %d\n", nid);
			pgdat->kswapd = NULL;
		}
	}
	pgdat_kswapd_unlock(pgdat);
}
```

kswapd的初始化由`kswapd_init`函数来完成，`kswapd_init`会由module_init宏来进行初始化。在这个函数中，他会遍历节点，为每个节点创建一个kswapd进程，并让pgdat->kswapd保存kswapd的进程描述符。



